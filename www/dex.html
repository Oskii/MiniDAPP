<html>

<head>
	<!--   The MINIMA MiFi Javascript Library -->
	<script type="text/javascript" src="./js/minima.js"></script>		
</head>

<body>

<script type="text/javascript">
	
	//Some Global variables..
	var allTokens    = {};
	var currentToken = {};
	var dexcontract  = "LET owner = PREVSTATE ( 0 ) IF SIGNEDBY ( owner ) THEN RETURN TRUE ENDIF LET address = PREVSTATE ( 1 ) LET token = PREVSTATE ( 2 ) LET amount = PREVSTATE ( 3 ) LET price = PREVSTATE ( 4 ) LET total = amount * price ASSERT VERIFYOUT ( @INPUT address total token )";
	var dexaddress   = "0x82EFF2D86E59919FB42D3EE6E1340627DF88D0E60636BA236C08D9799BD877C7";
	
	//The INIT function called once connected
	function init(){
		UpdateBlockTime();
		
		UpdateBalance();
			
		//Check for which Tokens are available..
		Minima.cmd("tokens", function(resp){
			//Changed..	
			UpdateTokensList(JSON.parse(resp).response);
		});
		
		StartPoller();
	}
	
	//Update the Balance Window - you can alwyas get the JSON in Minima.balance..
	function UpdateBalance(){
		var baltext = "<table width=100% border=0>"
		var len = Minima.balance.balance.length;
		for(var loop=0;loop<len;loop++){
			var json = Minima.balance.balance[loop];
			if(json.unconfirmed!="0" || json.mempool!="0"){
				baltext += "<tr class='infoboxblue'><td align=right width=30%>"+json.token
				+"&nbsp;&nbsp;</td> <td align=left>&nbsp;&nbsp;"+json.confirmed+" | "+json.unconfirmed+" | "+json.mempool+"</td>  </tr>";	
			}else{
				baltext += "<tr class='infoboxblue'><td align=right width=30%>"+json.token
				+"&nbsp;&nbsp;</td> <td align=left>&nbsp;&nbsp;"+json.confirmed+"</td>  </tr>";
			}
		}
		baltext += "</table>"
	
		//And set it..
		document.getElementById("minima_balance").innerHTML = baltext;
	}
	
	//Update Token List
	function UpdateTokensList(tokens_json){
		//Store..
		allTokens = tokens_json;
		
		//How many are there
		var len = tokens_json.tokens.length;
		if(len<2){
			//No Tokens.. since Minima is first
			document.getElementById("minima_tokenlist").innerHTML = "NO TOKENS FOUND.. &nbsp;&nbsp;<a href=''>REFRESH</a> ";
			return;
		}
		
		//Create the Select Box
		var toktext = "<b>CHOOSE TOKEN : </b> <select onchange='tokenSelectChange()' id='select_tokenlist'>"
		for(var loop=1;loop<len;loop++){
			var json = tokens_json.tokens[loop];
				toktext += "<option value='"+json.tokenid+"'>"+json.token+" ( "+json.total+" ) "+json.tokenid.substr(0,40)+"..</option>";
		}
		toktext += "</select> &nbsp;&nbsp;<a href=''>REFRESH</a>";
		
		//And set it..
		document.getElementById("minima_tokenlist").innerHTML = toktext;
		
		//Set the Token..
		tokenSelectChange()
	}
	
	//Update the BlockTime - use Minima.status
	function UpdateBlockTime(){
		document.getElementById("minima_blocktime").innerHTML = "<b>BLOCKTIME : </b> "+Minima.block;
	}
	
	//Simple Poll mechanic.. 
	function StartPoller(){
		pollFunction();
		
		//Check every 5 secs
		setInterval(function(){pollFunction();},5000);
	}
	
	function pollFunction(){
		
		
	}

	function tokenSelectChange(){
		var tokenSel  = document.getElementById("select_tokenlist").selectedIndex;
		currentToken  = allTokens.tokens[tokenSel+1];
		
		var tokenname = currentToken.token;
		console.log("Select : "+tokenname);
	}
	
	function actionBUY(){
		//Get the Values..
		var buyamount = document.getElementById("buyamt").value.trim();
		var buyprice  = document.getElementById("buyprice").value.trim();
		var token     = currentToken.token;
		
		if(buyamount=="" || buyprice==""){
			alert("Cannot have BLANK inputs!");
			return;
		}
		
		//Lets do this! - use Big Boy Maths Lib
		var tamount = new Decimal(buyamount);
		var tprice  = new Decimal(buyprice);
		var total = tamount.mul(tprice);
		
		if(tamount.lte(0) || tprice.lte(0)){
			alert("Cannot have ZERO inputs!");
			return;
		}
		
		//Check is OK
		if(!confirm("Please Confirm :\n\nBUY "+buyamount+" "+token+" @ "+buyprice+" Minima\n\nTotal Order Value : "+total)){
			return;
		}
		
		//We need a new key and a new address
		Minima.cmd( "keys new;newaddress;" , function(resp){
			keysjson = JSON.parse(resp);
			
			var pubkey  = keysjson[0].response.key.publickey;
			var address = keysjson[1].response.address.hexaddress;

			//Now create the txn..
			//The TXN ID is a random number..
			var txnid = Math.floor(Math.random()*1000000000);
			
			//Script to create transaction..
			var txncreator =    
				"txncreate "+txnid+";"+
				"txnauto "+txnid+" "+tamount+" "+dexaddress+";"+
				"txnstate "+txnid+" 0 "+pubkey+";"+
				"txnstate "+txnid+" 1 "+address+";"+
				"txnstate "+txnid+" 2 "+currentToken.tokenid+";"+
				"txnstate "+txnid+" 3 "+tamount+";"+
				"txnstate "+txnid+" 4 "+tprice+";"+
				"txnpost "+txnid+";";
				
			//And Run it..
			Minima.cmd( txncreator , function(resp){
				respjson = JSON.parse(resp);
				if(respjson[7].status == true){
					alert("ORDER POSTED!");
				}else{
					alert("Something went wrong.. Insufficient funds ?");
				}
			});	
		});
		
		
		
	}
	
	
	//Wait for the page to load..
	window.addEventListener("load", function(){
		//Listen for Minima Events
		window.addEventListener('MinimaEvent', function(evt) {
			//Deal with each message type
	 		if(evt.detail.event == "connected"){
	 			init();
	 			
	 		}else if(evt.detail.event == "newblock"){
		 		UpdateBlockTime();
		 		
	 		}else if(evt.detail.event == "newbalance"){
		 		UpdateBalance();
	 		}
	    });
		
		//Initialise MiFi
		Minima.init();
		
		//Scroll the order book..
		//var elem = document.getElementById("center_orderbook");  
		//elem.scrollIntoView(true); 
	});
	
</script>

<style>
.infobox {text-align:center;vertical-align:top;background-color: #ffd;border-radius: 10px;}
.divheader {text-align:center;font-weight:bold}
.scrollablediv {overflow-y:scroll;height:100%;}
.blue {background-color: #ddf}


.infoboxgreen {text-align:center;vertical-align:middle;background-color: #dfd;border-radius: 10px;}
.infoboxred {text-align:center;vertical-align:middle;background-color: #fdd;border-radius: 10px;}
.infoboxblue {text-align:center;vertical-align:middle;background-color: #ddf;border-radius: 10px;}

.infoboxyellow {text-align:center;vertical-align:middle;background-color: #ffd;border-radius: 10px;}

</style>

<center>

<br>
<h3>Super Simple On-Chain DEX</h3>
Market <b>MAKERS</b> use the <b>BUY</b> and <b>SELL</b> box to add an order to the orderbook. 
Market <b>TAKERS</b> click an order in the orderbook.
<br>
<br>

<table width=90% height=700 border=0>

<tr height=5%>
	<td colspan=2 class="infoboxblue">
		<div id="minima_tokenlist"></div>
	</td>
	
	<td width=33% class="infoboxblue">
		 <div id="minima_blocktime"></div> 
	</td>
</tr>

<tr>
	
	<td width=33%>
		<table width=100% height=100% border=0>
			<tr>
				<td class="infobox" height=30%>
				
					<table width=100% height=100%> 
					<tr>
						<th>MY BALANCE</th>
					</tr>
					<tr>
						<td height=100%>
							
							<div class="scrollablediv" id="minima_balance">
								
							</div>
							
						</td>
					</tr>
					</table>
					
				</td>
			</tr>
			
			<tr>
				<td class="infobox" height=35%>
				
					<table width=100% height=100%> 
					<tr>
						<th>MY ORDERS</th>
					</tr>
					<tr>
						<td height=100%>
							
							<div class="scrollablediv" id="minima_myorders">
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td><input type=submit value="Cancel"></td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td><input type=submit value="Cancel"></td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td><input type=submit value="Cancel"></td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td><input type=submit value="Cancel"></td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td><input type=submit value="Cancel"></td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
							</div>	
						</td>
					</tr>
					</table>
				
				</td>
			</tr>
			
			
			<tr>
				<td class="infobox" height=35%>
				
					<table width=100% height=100%> 
					<tr>
						<th>MY TRADES</th>
					</tr>
					<tr>
						<td height=100%>
							
							<div class="scrollablediv" id="minima_mytrades">
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td>@254</td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td>@254</td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td>@254</td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td>@254</td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td>@254</td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
								<table width=100% border=0>
									<tr><td>
										<table width=100%>
											<tr class="infoboxblue"><td colspan=2>PADDY</td> <td>@254</td> </tr>
											<tr class="infoboxred"><td>10</td> <td width=34%>0.02</td> <td width=33%>2</td></tr>
										</table>
									</td></tr>					
								</table>
								
														
							</div>	
						</td>
					</tr>
					</table>
				
				</td>
			</tr>
			
		</table>
		
	</td>
	
	<td width=34%>
	
		<table width=100% height=100% border=0>
			
			<tr>
				<td>
					
					<table width=100% height=100% border=0 style="vertical-align:top;background-color:#ffd;border-radius: 10px;">
						<tr height=5%>
							<th width=50% colspan=3>ORDERBOOK</th>
						</tr>
						<tr height=5%>
							<th width=33%>AMOUNT</th> <th width=34%>PRICE</th> <th width=33%>TOTAL</th>
						</tr>
						<tr>
							<td heigth=95% colspan=3>

								<!-- ORDER BOOK -->
								<div style="overflow-y:scroll;height:100%;vertical-align:bottom'">
									<table width=100%>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred" id="center_orderbook"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxred"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxblue"> <td colspan=3>-------</td>  </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
										<tr style="cursor: pointer;" class="infoboxgreen"> <td width=33%>10</td> <td width=34%>0.02</td> <td width=33%>2</td> </tr>
																
									</table>
								</div>
							
							</td>
						</tr>
						
					</table>
					
					
					
				</td>
			</tr>
			
			<tr>
				<td height=50 class="infoboxgreen">
					<b>BUY</b> <input type="number" style="width:120" id="buyamt" placeholder="Token Amount"> @ <input type="number" style="width:120" id="buyprice" placeholder="Price in Minima">
					&nbsp;<input onclick="actionBUY();" type="submit" value="Confirm"> 
				</td>
			</tr>
			
			<tr>
				<td height=50 class="infoboxred">
					<b>SELL</b> <input type="number" style="width:120" id="sellamt" placeholder="Token Amount"> @ <input type="number" style="width:120" id="sellprice" placeholder="Price in Minima">
					&nbsp;<input type="submit" value="Confirm"> 
				</td>
			</tr>
			
		</table>
	
	</td>
	
	<td width=33%>
	
		<table border=0 width=100% height=100%>
			
			<tr>
				<td style="vertical-align:top;background-color:#ffd;border-radius: 10px;">
					
					<div style="overflow-y:scroll;height:100%;'">
						<table width=100%>
							<tr> <th colspan=3> TRADES </th> </tr>
							<tr> <th width=33%>AMOUNT</th> <th width=34%>PRICE</th> <th width=33%>TIME</th> </tr>
							
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxgreen"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
							<tr class="infoboxred"> <td>10</td> <td>0.02</td> <td>345</td> </tr>
						
						</table>
					</div>
					
				</td>
			</tr>
			
		</table>
			
	</td>
		
</tr>
</table>
<br>
ps.. To create Tokens.. simply use the Mobile or Web app.. OR run 'createtoken name amount' in the Terminal.

</center>

</body>

</html>