<html>

<head>
	
	<!--   The MINIMA MiFi Javascript Library -->
	<script type="text/javascript" src="./js/minima.js"></script>
		
</head>

<body>

<script type="text/javascript">

	var coldkey  = "";
	var hotkey   = "";
	var rescaddr  = "";
	
	function initVault(){
		//we need to create 3 keys.. a hot, a cold, and a receiver address 
		var keycommand = "keys new;keys new;newaddress";
		Minima.cmd(keycommand, function(resp){
			//Save it for later..
			window.localStorage.setItem('MiniVault',resp);
			
			//Set them..
			setVaultKeys(resp);	
		});
	}
	
	function setVaultKeys(resp){
		var json = JSON.parse(resp);
		
		//Now get the 3 values..
		coldkey = json[0].response.key;
		hotkey  = json[1].response.key;
		rescaddr = json[2].response.address;
		
		//Set these details
		document.getElementById("coldkey").innerHTML   = coldkey;
		document.getElementById("hotkey").innerHTML    = hotkey;
		document.getElementById("rescuekey").innerHTML = rescaddr;
		
		createVault();
	}
	
	function createVault(){
		var vscript =   "LET pkcold = "+coldkey
			+ " LET pkhot = "+hotkey
			+ " IF SIGNEDBY ( pkcold ) THEN RETURN TRUE ENDIF "
			+ " LET amt = STATE ( 20 ) LET recip = STATE ( 21 ) "
			+ " LET safehouse = [ LET pkcold = "+coldkey
			+ " LET pkhot = "+hotkey
			+ " IF SIGNEDBY ( pkcold ) THEN RETURN TRUE ENDIF "
			+ " IF SIGNEDBY ( pkhot ) THEN IF @BLKDIFF GT 20 THEN"
			+ " RETURN VERIFYOUT ( @INPUT PREVSTATE ( 21 ) @AMOUNT @TOKENID ) ENDIF ENDIF ] "
			+ " ASSERT VERIFYOUT ( @INPUT SHA3 ( safehouse ) amt @TOKENID ) "
			+ " LET chg = @AMOUNT - amt "
			+ " IF chg GT 0 THEN ASSERT VERIFYOUT ( ( @INPUT + 1 ) @ADDRESS ( @AMOUNT - amt ) @TOKENID ) ENDIF "
			+ " IF SIGNEDBY ( pkhot ) THEN RETURN TRUE ENDIF";
	
		document.getElementById("vaultscript").innerHTML   = vscript;
		
		var shouse = "[ LET pkcold = "+coldkey
			+ " LET pkhot = "+hotkey
			+ " IF SIGNEDBY ( pkcold ) THEN RETURN TRUE ENDIF "
			+ " IF SIGNEDBY ( pkhot ) THEN IF @BLKDIFF GT 20 THEN"
			+ " RETURN VERIFYOUT ( @INPUT PREVSTATE ( 21 ) @AMOUNT @TOKENID ) ENDIF ENDIF ]"
		
			
	}

	//Wait for the page to load..
	window.addEventListener("load", function(){
	    //Listen for Minima Events
		window.addEventListener('MinimaEvent', function(evt) {
			//Deal with each message type
	 		if(evt.detail.event == "connected"){
	 			//Do we have them already..
	 			var jsontext = window.localStorage.getItem('MiniVault');
				if(jsontext!==null && jsontext!==""){
					setVaultKeys(jsontext);
				}else{
					//Do some setup..
		 			initVault();
				}
	 		}else if(evt.detail.event == "newblock"){
	 		
	 		}else if(evt.detail.event == "newbalance"){
		 		
	 		}
			
	    });
		
		//Initialise MiFi
		Minima.init();
	});
	
</script>

<center>
<br>
<h3>Vault Wallet</h3>
<br>
<br>
<div style='width:900;text-align:left;'>
Vault wallets are special. They use covenants to ensure that funds are ALWAYS sent to a safe house first. 

<br><br>
Vaults use 2 sets of keys. One that is HOT. These are kept ONLINE and are used to send funds from the vault to the safe house and eventually beyond. 
Another set is COLD. These are NEVER kept online and are only used in the event of a hack - or error in recipient. The HOT keys can be hacked.. and it's really no big deal.

<br><br>
What this means is that when you wish to send funds they MUST first be sent to a special address for 
a period of time - the Safe House. This is enforced by the smart contract. Even you the owner of the vault must do this, and so therefore 
even the hacker who has pinched the keys. Once the funds are at the safe house, you must wait a certain amount of time 
until you can send them on to ONLY the pre-specified address. If they were sent by a hacker - you the owner can claim them 
back with your COLD key.

<br><br>
Hot wallet convenience with cold wallet security and all it takes is a little delay. An exchange, for instance, can keep large amounts online and available to send this way. Simple (yet secure).  

<br><br>
So - let's play.. All the setup is done in the background.. just make sure you have some funds so that the Vault Wallet can be filled.

<br><br>
</div>
<br>
<button onclick='initVault();';>NEW VAULT</button>
<table>

<tr>
<td>
	<b>VAULT</b>
	<div style="font-family:monospace; font-size=14;width: 750px; background-color: #ccc;border-radius: 10px;">
	<br>
	<table width=100% border=0>
	<tr>
		<td width=150 align=right nowrap>Cold Key : </td>
		<td> <div id='coldkey'>0</div></td>
	</tr>
	
	<tr>
		<td align=right nowrap>Hot Key : </td>
		<td> <div id='hotkey'>0</div></td>
	</tr>
	
	<tr>
		<td colspan=2>&nbsp;</td>
	</tr>
	
	<tr>
		<td align=right nowrap>Rescue address : </td>
		<td> <div id='rescuekey'>0</div></td>
	</tr>
	
	<tr>
		<td colspan=2>&nbsp;</td>
	</tr>
	
	<tr>
		<td align=right nowrap>Vault Address : </td>
		<td> <div id='vaultaddress'>0</div></td>
	</tr>
	
	<tr>
		<td align=right nowrap>Vault Balance : </td>
		<td> <div id='vaultbalance'>0</div></td>
	</tr>
	
	<tr>
		<td colspan=2>&nbsp;</td>
	</tr>
	
	<tr>
		<td align=right>Amount : </td> <td> <input type='text' id='amount'></td>
	</tr>
	
	<tr>
		<td align=right>Address : </td> <td> <input type='text' id='address'></td>
	</tr>
	
	<tr><td colspan=2>&nbsp;</td></tr>
	
	<tr>
		<td colspan=2 align=right> <button onclick='send();return false;'>SEND TO SAFE HOUSE</button>&nbsp;&nbsp;&nbsp;</td>
	</tr>
		
	<tr><td colspan=2>&nbsp;</td></tr>
	</table>
</div>

<br><br>

<b>SAFE HOUSE</b> 
<div style="font-family:monospace; font-size=14;width: 750px; height: 300px;background-color: #ccc;border-radius: 10px;">
<br>
<table>
<table width=100% heigth=100% border=1>
	<tr>
		<td width=150 align=right nowrap>Address : </td>
		<td> <div id='reckey'>0</div></td>
	</tr>
	
	<tr>
		<td align=right nowrap>Hot Key : </td>
		<td> <div id='hotkey'>0</div></td>
	</tr>
	
	<tr>
		<td align=left><br><br>Using the COLD key..<br><button>RESCUE FUNDS</button></td>
		<td align=right><br><br>If all ok..<br><button>FORWARD FUNDS</button></td>
	</tr>
</table>
</div>

</td>

</tr>

</table>


<br>
Here is the Vault script : <br>
<div style='width:900;text-align:left;font-size:13px;font-family:monospace;'>
<br>
<b>
/* The HOT and COLD keys */<br>
LET pkcold = THE_COLD_KEY<br>
LET pkhot = THE_HOT_KEY<br>
<br>
/* COLD key always has root access*/<br>
IF SIGNEDBY ( pkcold ) THEN RETURN TRUE ENDIF<br>
<br>
/* How much are you sending and to who is specified in the STATE and accessible in PREVSTATE from the Safe House */<br>
LET amt = STATE ( 20 )<br>
<br>
/* Allthough specified it's not actuallly used.. it's for the follow up transaction */<br> 
LET recip = STATE ( 21 )<br>
<br>
/* Construct the script output for the safe house */<br>
LET safehouse = [ LET pkcold = 0x7B23F0670FE0DFE17EE74D5DCB3AF4AE00E454044F1CF1DA4FDADC133EC7A3E6 LET pkhot = 0x74A2222436C592046A6F576F67200C75DB3D9051BE31262BD0A0BF0DB30137C4 IF SIGNEDBY ( pkcold ) THEN RETURN TRUE ENDIF IF SIGNEDBY ( pkhot ) THEN LET blkdiff = @BLKNUM - @INBLKNUM IF blkdiff GT 20 THEN RETURN VERIFYOUT ( @INPUT PREVSTATE ( 21 ) @AMOUNT @TOKENID ) ENDIF ENDIF ]<br> 
<br>
/* Check that the correct output exists */<br>
ASSERT VERIFYOUT ( @INPUT SHA3 ( safehouse ) amt @TOKENID )<br>
<br>
/* Make sure the change is sent back to the Vault */<br>
LET change = @AMOUNT - amt<br>
IF change GT 0 THEN <br>
&nbsp;&nbsp;ASSERT VERIFYOUT ( ( @INPUT + 1 ) @ADDRESS change @TOKENID )<br>
ENDIF<br>
<br>
/* Finally - it must be signed by the HOT key*/<br>
IF SIGNEDBY ( pkhot ) THEN RETURN TRUE ENDIF<br>
</b>
</div>
<br>
<b>VAULT CODE</b> : 
<div id="vaultscript" style='background-color:#CCCCCC;color:#000000;width:900;text-align:left;font-size:13px;font-family:monospace;'></div>

<br><Br>Here is the Safe House : <br>
<div style='width:900;text-align:left;font-size:13px;font-family:monospace;'>
<br>
<b>
/* The HOT and COLD key */<br>
LET pkcold = THE_COLD_KEY<br>
LET pkhot = THE_HOT_KEY<br>
<br>
/* Cold key has root - rescue the funds */<br>
IF SIGNEDBY ( pkcold ) THEN RETURN TRUE ENDIF<br>
<br>
/* Can ONLY be forwarded to the pre-designated address.. by the HOT key*/<br> 
IF SIGNEDBY ( pkhot ) THEN<br>
<br>
&nbsp;/* Need to wait a certain amount of time */<br> 
&nbsp;LET blkdiff = @BLKNUM - @INBLKNUM<br>
&nbsp;IF blkdiff GT 20 THEN <br>
<br>
&nbsp;&nbsp;/* Make sure the output exists to the correct address */<br>
&nbsp;&nbsp;RETURN VERIFYOUT ( @INPUT PREVSTATE(21) @AMOUNT @TOKENID ) <br>
<br>  
&nbsp;ENDIF<br>   
<br>
ENDIF<br>
<br>
</b>
</div>

<br><br><a href='index.html'>HOME</a>
</center>

</body>

</html>