<html>

<head>
	
	<!--   The MINIMA MiFi Javascript Library -->
	<script type="text/javascript" src="./js/minima.js"></script>
		
</head>

<body>

<script type="text/javascript">
	//Wait for the page to load..
	window.addEventListener("load", function(){
		//Listen for Minima Events
		window.addEventListener('MinimaEvent', function(evt) {
			//Deal with each message type
	 		if(evt.detail.event == "connected"){
		 		//Connected..	
	 		}
	    });
		//Initialise MiFi
		Minima.init();
		
		//Load cached if available..
		loadScript();
	});

	//Clean the script to make it easy to use in commands..
	function cleanScript(){
		var txt = document.getElementById("scriptarea").value.trim();
		
		//if(document.getElementById("autosave").checked){
		//	saveScript();	
		//}
		
		//small touch..
		//var nocomm = txt.replace(/\n/g," ");
		//nocomm =  nocomm.replace(/\/\*.*\*\//g, " ");
		//nocomm =  nocomm.replace(/\s+/g, " ").trim();
		
		var script = txt.replace(/\n/g," ");
		var state = "state:"+document.getElementById("state").value.trim();
		var prevstate = "prevstate:"+document.getElementById("prevstate").value.trim();
		var sigs = "sigs:"+document.getElementById("sigs").value.trim();
		
		
		//Clean it..
		Minima.cmd("runscript \""+script+"\" \""+state+"\" \""+prevstate+"\" \""+sigs+"\" ",function(resp){
			console.log(resp);
			var json = JSON.parse(resp);
			var brkscr = json.response.parse.replace(/\n/g,"<br>");
			
			var res = "-------------------<br>";
			if(json.response.parseok){
				res += "PARSE OK : ";	
			}else{
				res += "PARSE FAIL : ";	
			}
			
			if(json.response.return){
				res += "RUN OK ";	
			}else{
				res += "RUN FAIL ";	
			}
			
			//Set it
			document.getElementById("parse").innerHTML = res+"<br>-------------------<br>"+brkscr;	
			document.getElementById("parse").scrollTop = 0;
			
			document.getElementById("clean").innerHTML = json.response.clean;
			document.getElementById("clean").scrollTop = 0;
			
			//Set the global address
			document.getElementById("globaddress").value = json.response.address;
		});
	}
	
	function saveScript(){
		//Which script is this..
		var sel = document.getElementById("scripts").selectedIndex;
		
		//Get all this different parts..
		var scriptarea = document.getElementById("scriptarea").value;
		var state      = document.getElementById("state").value;
		var prevstate  = document.getElementById("prevstate").value;
		var sigs       = document.getElementById("sigs").value;
		
		//Create a JSON out of it..
		var storejson = { "script":scriptarea, "state":state, "prevstate":prevstate, "sigs":sigs };
		
		//Convert the whole thing to a tring
		var jsontext = JSON.stringify(storejson);
		
		console.log("SAVE JSON:"+jsontext);
		
		//Now store it..
	    window.localStorage.setItem('ScriptIDE'+sel,jsontext);
	}
	
	var prevsel = 0;
	function loadScript(){
		//Load cached if available..
		var sel = document.getElementById("scripts").selectedIndex;
		
		//Load the JSON
		var jsontext = window.localStorage.getItem('ScriptIDE'+sel);
		
		console.log("LOAD JSON:"+jsontext);
		
		if(jsontext != null){
			//Convert to a JSON
			var json = JSON.parse(jsontext);
			
			document.getElementById("scriptarea").value = json.script;
			document.getElementById("state").value      = json.state;
			document.getElementById("prevstate").value  = json.prevstate;
			document.getElementById("sigs").value       = json.sigs;
		}else{
			//Reset the values..
			document.getElementById("scriptarea").value = "";
			document.getElementById("state").value      = "";
			document.getElementById("prevstate").value  = "";
			document.getElementById("sigs").value       = "";
		}
		
		//Save the OLD
		//if(document.getElementById("autosave").checked){
		//	var save = document.getElementById("scriptarea").value;
		//	window.localStorage.setItem('ScriptIDE'+prevsel,save);
		//}
		//prevsel = sel;
		
		//reset..
		document.getElementById("parse").innerHTML = "";
		document.getElementById("clean").innerHTML = "";
	}
	
	function addOutput(){
		var table = document.getElementById("outputtable");
		var rows  = table.getElementsByTagName("tr")
		var len   = rows.length;
		
		var row = table.insertRow(len);
		
		var output  = row.insertCell(0);
		var address = row.insertCell(1);
		var amount  = row.insertCell(2);
		var tokenid = row.insertCell(3);
		
		//Get the data..
		var out  = len-2;
		var addr = document.getElementById("output_address").value;
		var amt  = document.getElementById("output_amount").value;
		var tok  = document.getElementById("output_tokenid").value;
		
		//Data..
		output.id = "table_output_"+len;
		output.innerHTML = ""+out;
		
		address.id = "table_address_"+len;
		address.innerHTML = ""+addr;
		
		amount.id = "table_amount_"+len;
		amount.innerHTML = ""+amt;
		
		tokenid.id = "table_tokenid_"+len;
		tokenid.innerHTML = ""+tok;
	}
	
	function deleteOutput(){
		var table = document.getElementById("outputtable");
		var rows  = table.getElementsByTagName("tr")
		var len   = rows.length;
		
		if(len>2){
			table.deleteRow(len-1);	
		}
	}
	
</script>

<center>
<br>
<h3>Minima Script IDE</h3>
<br>

<table border=0>
<tr>
	<td colspan=2><b>STATE</b> - # separated list of state variables.. number:value<br>
	<textarea placeholder='0:0xFF # 34:123.32 # 45:[ LET cc = 43 ]' style='resize: none;width: 950px;' rows=1 id='state' spellcheck="false" ></textarea></td>
</tr>

<tr>
	<td colspan=2><b>PREVSTATE</b> - # separated list of previous state variables.. number:value<br>
	<textarea style='resize: none;width: 950px;' rows=1 id='prevstate' spellcheck="false" ></textarea></td>
</tr>

<tr>
	<td colspan=2><b>SIGNATURES</b> - # separated list of public keys (can be shorter 0xFF for debugging)<br>
	<textarea placeholder='0XFF # 0x123 # 0x3A5D322E1F3562ABDDF6FB23E120E233BEADD695E38A2012DF349B26A040CBAA' style='resize: none;width: 950px;' rows=1 id='sigs' spellcheck="false" ></textarea></td>
</tr>

<tr>
	<td colspan=2><br><b>GLOBALS</b> - the predefined variables every script has access to. NON-Blank are set<br>
	<table style='background-color:#CCCCCC;font-size:12px;font-family:monospace;width:950px;'>
		<tr> 
			<td align=right>@BLKNUM : </td>  <td align=left><input type=text id="globblknum" value=""></td>
		    <td align=right>@INBLKNUM : </td>  <td align=left><input type=text id="globinblknum" value=""></td>
		    <td align=right>@INPUT : </td>  <td align=left><input type=text id="globinput" value=""></td>
		</tr>
		<tr> 
			<td align=right>@ADDRESS : </td>  <td align=left><input readonly type=text id="globaddress" value=""></td>
		    <td align=right>@AMOUNT : </td>  <td align=left><input type=text id="globamount" value=""></td>
		    <td align=right>@TOKENID : </td>  <td align=left><input type=text id="globtokenid" value=""></td>
		</tr>
		<tr> 
			<td align=right>@COINID : </td>  <td align=left><input type=text id="globcoinid" value=""></td>
		    <td align=right>@TOTIN : </td>  <td align=left><input type=text id="globtotin"  spellcheck="false" value=""></td>
		    <td align=right>@TOTOUT : </td>  <td align=left><input type=text id="globtotout"  spellcheck="false" value=""></td>
		</tr>
	</table>
	</td>
</tr>

<tr>
	<td colspan=2><br><b>OUTPUTS</b> - outputs that exist in the transaction<br>
	
	<table id="outputtable" style='font-family:monospace;'>
		<tr>
			<th align=left>OUTPUT</th>
			<th align=left>ADDRESS</th>
			<th align=left>AMOUNT</th>
			<th align=left>TOKENID</th>
			<th>&nbsp;</th>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td><input type='text' id='output_address' value="0xFF"></td>
			<td><input type='text' id='output_amount' value=0 size=10></td>
			<td><input type='text' id='output_tokenid' value="0x00"></td>
			<td><button onclick='addOutput();'>ADD</button>&nbsp;<button onclick='deleteOutput();'>DELETE</button> </td>
		</tr>
		
	</table>

	</td>
<tr>
	<td colspan=2><br><b>SCRIPT</b> - /* .. */ comments are supported and will be removed automagically<br>
	<textarea style='resize: none;width: 950px;height: 360px;' id='scriptarea' spellcheck="false" ></textarea></td>
</tr>

<tr>
	<td align=left>
		<select id="scripts" onchange="loadScript();">
		  <option value="1">SCRIPT_1</option>
		  <option value="2">SCRIPT_2</option>
		  <option value="3">SCRIPT_3</option>
		  <option value="4">SCRIPT_4</option>
		  <option value="5">SCRIPT_5</option>
		  <option value="6">SCRIPT_6</option>
		  <option value="7">SCRIPT_7</option>
		  <option value="8">SCRIPT_8</option>
		</select>
		<input type="checkbox" id="autosave" name='autosave'> <label for="autosave">AUTOSAVE</label>
		&nbsp;
		&nbsp;
		<button onclick='loadScript();'>LOAD</button>
		<button onclick='saveScript();'>SAVE</button>
	</td>
	
	<td align=right>
	    <!-- <button onclick='document.getElementById("scriptarea").value = "";'>CLEAR</button> -->
		<button onclick='cleanScript();'>RUN SCRIPT</button>
	</td>
</tr>

<tr>
	<td colspan=2><br>CLEAN SCRIPT<div id='clean' style='font-size:12px;font-family:monospace;overflow-y: auto;text-align:left;width:950px;height:80px;background-color:#CCCCCC;color:#000000;'></div></td>
</tr>

<tr>
	<td colspan=2><br>RUN RESULT<div id='parse' style='font-size:12px;font-family:monospace;overflow-y: auto;text-align:left;width:950px;height:200px;background-color:#CCCCCC;color:#000000;'></div></td>
</tr>

</table>

<br><br>
 
<br><br><a href='index.html'>HOME</a>
</center>

</body>

</html>